<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>부동산 서비스 회원가입</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter & Noto Sans KR) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", "Noto Sans KR", sans-serif;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex items-center justify-center px-4 py-8"
  >
    <div class="w-full max-w-lg">
      <!-- 회원가입 카드 -->
      <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
        <!-- 헤더 -->
        <div class="px-6 pt-6 pb-4 text-center">
          <!-- 로고 -->
          <div class="mb-4">
            <div
              class="w-16 h-16 mx-auto bg-green-400 rounded-2xl flex items-center justify-center mb-3"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1V10m-9-10"
                />
              </svg>
            </div>
            <h1 class="text-xl font-bold text-gray-800">회원가입</h1>
            <p class="text-gray-600 text-sm mt-1">새로운 계정을 만들어보세요</p>
          </div>
        </div>

        <!-- 회원가입 폼 -->
        <div class="px-6 pb-6">
          <form id="signupForm" class="space-y-4">
            <!-- 사용자 유형 선택 (필수) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">
                사용자 유형 <span class="text-red-500">*</span>
              </label>
              <div class="grid grid-cols-1 gap-2">
                <label class="relative cursor-pointer">
                  <input
                    type="radio"
                    name="roleId"
                    value="regular"
                    class="sr-only peer"
                    checked
                  />
                  <div
                    class="p-3 border-2 border-gray-200 rounded-2xl text-center peer-checked:border-green-400 peer-checked:bg-green-50 transition-all"
                  >
                    <div class="flex items-center">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 text-gray-600 peer-checked:text-green-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                      </svg>
                      <div class="text-left">
                        <span class="text-sm font-medium text-gray-900"
                          >일반 사용자</span
                        >
                        <p class="text-xs text-gray-500">매물 검색 및 조회</p>
                      </div>
                    </div>
                  </div>
                </label>

                <label class="relative cursor-pointer">
                  <input
                    type="radio"
                    name="roleId"
                    value="broker"
                    class="sr-only peer"
                  />
                  <div
                    class="p-3 border-2 border-gray-200 rounded-2xl text-center peer-checked:border-green-400 peer-checked:bg-green-50 transition-all"
                  >
                    <div class="flex items-center">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 text-gray-600 peer-checked:text-green-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                        />
                      </svg>
                      <div class="text-left">
                        <span class="text-sm font-medium text-gray-900"
                          >중개인</span
                        >
                        <p class="text-xs text-gray-500">
                          매물 등록 및 중개 업무
                        </p>
                      </div>
                    </div>
                  </div>
                </label>

                <label class="relative cursor-pointer">
                  <input
                    type="radio"
                    name="roleId"
                    value="admin"
                    class="sr-only peer"
                  />
                  <div
                    class="p-3 border-2 border-gray-200 rounded-2xl text-center peer-checked:border-red-400 peer-checked:bg-red-50 transition-all"
                  >
                    <div class="flex items-center">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 text-gray-600 peer-checked:text-red-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                        />
                      </svg>
                      <div class="text-left">
                        <span class="text-sm font-medium text-gray-900"
                          >관리자</span
                        >
                        <p class="text-xs text-gray-500">시스템 관리 및 운영</p>
                      </div>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- 필수 정보 섹션 -->
            <div class="border-t pt-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">필수 정보</h3>

              <!-- 이메일 입력 (필수) -->
              <div class="mb-4">
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  이메일 <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="example@email.com"
                />
              </div>

              <!-- 사용자명 입력 (필수) -->
              <div class="mb-4">
                <label
                  for="username"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  사용자명 <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="username"
                  name="username"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="사용자명 또는 닉네임"
                />
              </div>

              <!-- 비밀번호 입력 (필수) -->
              <div class="mb-4">
                <label
                  for="password"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  비밀번호 <span class="text-red-500">*</span>
                  <small class="text-gray-500">(8자 이상)</small>
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  minlength="8"
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="8자 이상의 비밀번호를 입력하세요"
                />
              </div>

              <!-- 비밀번호 확인 (필수) -->
              <div class="mb-4">
                <label
                  for="confirmPassword"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  비밀번호 확인 <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="비밀번호를 다시 입력하세요"
                />
              </div>
            </div>

            <!-- 선택 정보 섹션 -->
            <div class="border-t pt-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">선택 정보</h3>

              <!-- 전화번호 입력 (선택) -->
              <div class="mb-4">
                <label
                  for="phoneNumber"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >전화번호</label
                >
                <input
                  type="tel"
                  id="phoneNumber"
                  name="phoneNumber"
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="010-0000-0000"
                />
              </div>

              <!-- 자기소개 입력 (선택) -->
              <div class="mb-4">
                <label
                  for="intro"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >자기소개</label
                >
                <textarea
                  id="intro"
                  name="intro"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400 resize-none"
                  placeholder="간단한 자기소개를 작성해주세요"
                ></textarea>
              </div>
            </div>

            <!-- 중개인 전용 정보 섹션 (동적으로 표시/숨김) -->
            <div id="brokerFields" class="border-t pt-4 hidden">
              <h3 class="text-sm font-medium text-gray-700 mb-3">
                중개인 정보
              </h3>

              <!-- 중개사 면허 번호 입력 (중개인 필수) -->
              <div class="mb-4">
                <label
                  for="licenseNumber"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  중개사 면허 번호 <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="licenseNumber"
                  name="licenseNumber"
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="중개사 면허 번호를 입력하세요"
                />
              </div>

              <!-- 소속 중개사무소 입력 (중개인 선택) -->
              <div class="mb-4">
                <label
                  for="agencyName"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >소속 중개사무소</label
                >
                <input
                  type="text"
                  id="agencyName"
                  name="agencyName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                  placeholder="소속 중개사무소명을 입력하세요"
                />
              </div>
            </div>

            <!-- 이용약관 동의 -->
            <div class="border-t pt-4">
              <label class="flex items-start">
                <input
                  type="checkbox"
                  id="agreeTerms"
                  required
                  class="mt-1 rounded border-gray-300 text-green-400 focus:ring-green-400"
                />
                <span class="ml-2 text-sm text-gray-600">
                  <span class="text-red-500">*</span>
                  <a
                    href="#"
                    class="text-green-500 hover:text-green-700 underline"
                    >이용약관</a
                  >
                  및
                  <a
                    href="#"
                    class="text-green-500 hover:text-green-700 underline"
                    >개인정보처리방침</a
                  >에 동의합니다.
                </span>
              </label>
            </div>

            <!-- 회원가입 버튼 -->
            <button
              type="submit"
              class="w-full bg-green-400 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-2xl transition-colors mt-6"
            >
              회원가입
            </button>

            <!-- 로그인 링크 -->
            <div class="text-center">
              <p class="text-sm text-gray-600">
                이미 계정이 있으신가요?
                <a
                  href="loginX.html"
                  class="text-green-500 hover:text-green-700 font-medium"
                  >로그인</a
                >
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // 폼 제출 처리
      document
        .getElementById("signupForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const password = formData.get("password");
          const confirmPassword = formData.get("confirmPassword");
          const agreeTerms = document.getElementById("agreeTerms").checked;

          // 비밀번호 길이 확인
          if (password.length < 8) {
            alert("비밀번호는 8자 이상이어야 합니다.");
            return;
          }

          // 비밀번호 확인
          if (password !== confirmPassword) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
          }

          // 이용약관 동의 확인
          if (!agreeTerms) {
            alert("이용약관에 동의해주세요.");
            return;
          }

          // 로딩 애니메이션
          const submitButton = this.querySelector('button[type="submit"]');
          const originalText = submitButton.innerHTML;
          submitButton.innerHTML = "가입 중...";
          submitButton.disabled = true;

          // 선택된 역할 확인
          const selectedRole = formData.get("roleId");

          // 중개인 선택 시 필수 필드 검증
          if (selectedRole === "broker") {
            const licenseNumber = formData.get("licenseNumber");
            if (!licenseNumber || licenseNumber.trim() === "") {
              alert("중개사 면허 번호는 필수 입력 항목입니다.");
              submitButton.innerHTML = originalText;
              submitButton.disabled = false;
              return;
            }
          }

          // 회원가입 API 호출
          const signupData = {
            email: formData.get("email"),
            username: formData.get("username"),
            password: formData.get("password"),
            role: selectedRole,
            phoneNumber: formData.get("phoneNumber") || null,
            intro: formData.get("intro") || null,
            profileImageUrl: null,
            licenseNumber:
              selectedRole === "broker" ? formData.get("licenseNumber") : null,
            agencyName:
              selectedRole === "broker" ? formData.get("agencyName") : null,
          };

          console.log("회원가입 데이터:", signupData);

          fetch("/api/auth/signup", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(signupData),
          })
            .then((response) => {
              console.log("응답 상태:", response.status);
              if (!response.ok) {
                return response.text().then((text) => {
                  console.error("에러 응답:", text);
                  let errorMessage = text;
                  try {
                    const errorJson = JSON.parse(text);
                    errorMessage = errorJson.error || errorJson.message || text;
                  } catch (e) {
                    // JSON 파싱 실패시 원본 텍스트 사용
                  }
                  throw new Error(errorMessage || "회원가입에 실패했습니다.");
                });
              }
              return response;
            })
            .then(() => {
              alert("회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.");
              window.location.href = "loginX.html";
            })
            .catch((error) => {
              console.error("회원가입 오류:", error);
              alert(
                error.message ||
                  "회원가입 중 오류가 발생했습니다. 다시 시도해주세요."
              );

              // 버튼 상태 복원
              submitButton.innerHTML = originalText;
              submitButton.disabled = false;
            });
        });

      // 사용자 유형 변경 시 스타일 업데이트 및 중개인 필드 표시/숨김
      document.querySelectorAll('input[name="roleId"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          // 모든 라벨에서 선택된 스타일 제거
          document.querySelectorAll('input[name="roleId"]').forEach((r) => {
            const label = r.closest("label");
            const div = label.querySelector("div");
            if (r.value === "admin") {
              div.classList.remove("border-red-400", "bg-red-50");
            } else {
              div.classList.remove("border-green-400", "bg-green-50");
            }
            div.classList.add("border-gray-200");
          });

          // 선택된 라벨에 스타일 적용
          const parentLabel = this.closest("label");
          const div = parentLabel.querySelector("div");
          if (this.value === "admin") {
            div.classList.add("border-red-400", "bg-red-50");
          } else {
            div.classList.add("border-green-400", "bg-green-50");
          }
          div.classList.remove("border-gray-200");

          // 중개인 전용 필드 표시/숨김
          const brokerFields = document.getElementById("brokerFields");
          const licenseNumberInput = document.getElementById("licenseNumber");
          const agencyNameInput = document.getElementById("agencyName");

          if (this.value === "broker") {
            brokerFields.classList.remove("hidden");
            licenseNumberInput.required = true;
          } else {
            brokerFields.classList.add("hidden");
            licenseNumberInput.required = false;
            licenseNumberInput.value = "";
            agencyNameInput.value = "";
          }
        });
      });
    </script>
  </body>
</html>
