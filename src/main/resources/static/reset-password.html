<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>비밀번호 재설정</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">
<div class="w-full max-w-md bg-white rounded-2xl shadow p-6">
    <h1 class="text-xl font-bold mb-4">비밀번호 재설정</h1>
    <p class="text-sm text-gray-600 mb-6">새 비밀번호를 입력하세요.</p>

    <form id="resetForm" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">새 비밀번호</label>
            <input id="newPassword" type="password" required minlength="8"
                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring"
                   placeholder="새 비밀번호" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">새 비밀번호 확인</label>
            <input id="newPassword2" type="password" required minlength="8"
                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring"
                   placeholder="새 비밀번호 확인" />
        </div>
        <button type="submit"
                class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
            비밀번호 변경
        </button>
        <p id="msg" class="text-sm mt-2"></p>
    </form>
</div>

<script>
    // URL의 ?token= 값을 읽는다
    const params = new URLSearchParams(location.search);
    const token = params.get("token");

    const form = document.getElementById("resetForm");
    const msg = document.getElementById("msg");

    if (!token) {
      msg.className = "text-sm mt-2 text-red-600";
      msg.textContent = "유효하지 않은 링크입니다. (토큰 없음)";
      form.querySelector("button").disabled = true;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const p1 = document.getElementById("newPassword").value.trim();
      const p2 = document.getElementById("newPassword2").value.trim();

      if (p1.length < 8) {
        msg.className = "text-sm mt-2 text-red-600";
        msg.textContent = "비밀번호는 8자 이상이어야 합니다.";
        return;
      }
      if (p1 !== p2) {
        msg.className = "text-sm mt-2 text-red-600";
        msg.textContent = "두 비밀번호가 일치하지 않습니다.";
        return;
      }

      try {
        const res = await fetch("/api/auth/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: token, newPassword: p1 }),
        });

        if (res.ok) {
          msg.className = "text-sm mt-2 text-green-600";
          msg.textContent = "비밀번호가 변경되었습니다. 로그인 페이지로 이동합니다...";
          setTimeout(() => (window.location.href = "/loginX.html"), 1200);
        } else {
          const text = await res.text();
          msg.className = "text-sm mt-2 text-red-600";
          msg.textContent = text || "링크가 만료되었거나 이미 사용되었습니다.";
        }
      } catch (err) {
        msg.className = "text-sm mt-2 text-red-600";
        msg.textContent = "요청 중 오류가 발생했습니다. 잠시 후 다시 시도하세요.";
        console.error(err);
      }
    });
</script>
</body>
</html>
